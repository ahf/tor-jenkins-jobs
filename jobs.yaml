- defaults:
    name: global
    description: 'Do not edit this job through the web'
    project-type: matrix
    block-upstream: true
    scm:
       - git:
           url: "{git-url}"
           basedir: source
    execution-strategy:
        sequential: true
        touchstone:
            expr: '(ARCHITECTURE=="amd64" && SUITE=="wheezy")'
            result: stable
    axes:
        - axis:
            type: label-expression
            name: ARCHITECTURE
            values:
                - amd64
                - i386
        - axis:
            type: label-expression
            name: SUITE
            values:
                - squeeze
                - wheezy
                - lucid
                - natty
                - oneiric
                - precise
                - quantal
                - sid
    logrotate:
        daysToKeep: -1
        numToKeep: 5
        artifactDaysToKeep: -1
        artifactNumToKeep: -1
    wrappers:
        - timestamps
        - timeout:
            timeout: 600
            fail: true
        - matrixtieparent:
            labelname: master

# our actual projects
- job:
    name: tor-ci-linux
    node: Linux
    scm:
        - git:
            url: 'https://git.torproject.org/tor.git'
            branches:
                - master
                - maint-0.2.3
                - maint-0.2.4
    builders:
        - shell: "/home/jenkins/jenkins-tools/slaves/linux/build-wrapper"
    triggers:
        - pollscm: "*/10 * * * *"
    publishers:
        - archive:
            artifacts: "src/or/tor"
- job:
    name: tor-ci-linux-clang
    project-type: matrix
    execution-strategy:
        sequential: true
        touchstone:
            expr: '(ARCHITECTURE=="amd64" && SUITE="sid")'
            result: stable
        combination-filter: '(ARCHITECTURE=="amd64" || SUITE=="experimental")'
    axes:
        - axis:
            type: label-expression
            name: SUITE
            values:
                - sid
                - experimental
        - axis:
            type: label-expression
            name: ARCHITECTURE
            values:
                - amd64
                - i386
    scm:
        - git:
            url: 'https://git.torproject.org/tor.git'
            branches:
                - master
                - maint-0.2.3
                - maint-0.2.4
    builders:
        - shell: "/home/jenkins/jenkins-tools/slaves/linux/build-wrapper"
    triggers:
        - pollscm: "*/10 * * * *"
- job:
    name: tor-ci-windows
    project-type: freestyle
    node: windows
    scm:
        - git:
            url: 'https://git.torproject.org/tor.git'
            branches:
                - master
                - maint-0.2.3
                - maint-0.2.4
    builders:
        - copyartifact:
            project: extern-windows-libevent
            which-build: "last-successful"
        - copyartifact:
            project: extern-windows-openssl
            which-build: "last-successful"
        - copyartifact:
            project: extern-windows-zlib
            which-build: "last-successful"
        - shell: '~/jenkins-tools/slaves/windows/build-wrapper'
    triggers:
        - pollscm: "*/10 * * * *"
    publishers:
        - archive:
            artifacts: "RESULT.tor.tar.gz"
    wrappers:
        - timestamps
        - timeout:
            timeout: 600
            fail: true

# vidalia
- job:
    name: vidalia-ci-linux
    node: Linux
    scm:
        - git:
            url: 'https://git.torproject.org/vidalia.git'
            branches:
                - master
                - maint-0.2.3
                - maint-0.2.4
    builders:
        - shell: "/home/jenkins/jenkins-tools/slaves/linux/build-wrapper"
    triggers:
        - pollscm: "*/10 * * * *"
- job:
    name: vidalia-ci-windows
    project-type: freestyle
    node: windows
    scm:
        - git:
            url: 'https://git.torproject.org/vidalia.git'
            branches:
                - master
    builders:
        - copyartifact:
            project: extern-windows-qt
            which-build: "last-successful"
        - shell: '~/jenkins-tools/slaves/windows/build-wrapper'
    triggers:
        - pollscm: "*/10 * * * *"
    publishers:
        - archive:
            artifacts: "RESULT.vidalia.tar.gz"
    wrappers:
        - timestamps
        - timeout:
            timeout: 600
            fail: true

# our actual projects
- job:
    name: stem-ci-linux
    node: Linux
    scm:
        - git:
            url: 'https://git.torproject.org/stem.git'
            branches:
                - master
    builders:
        - shell: "/home/jenkins/jenkins-tools/slaves/linux/build-wrapper"
    triggers:
        - pollscm: "*/10 * * * *"

- job:
    name: stem-tor-ci-base
    project-type: freestyle
    node: Linux
    scm:
        - git:
            url: 'https://git.torproject.org/tor.git'
            branches:
                - master
    builders:
        - shell: "SUITE=squeeze ARCHITECTURE=amd64 /home/jenkins/jenkins-tools/slaves/linux/build-wrapper"
    triggers:
        - pollscm: "*/10 * * * *"
    publishers:
        - archive:
            artifacts: "src/or/tor"
        - trigger:
            project: stem-tor-ci
    wrappers:
        - timestamps
        - timeout:
            timeout: 600
            fail: true

- job:
    name: stem-tor-ci
    project-type: freestyle
    node: Linux
    scm:
        - git:
            url: 'https://git.torproject.org/stem.git'
            branches:
                - master
    builders:
        - copyartifact:
            project: stem-tor-ci-base
            which-build: "last-successful"
        - shell: "SUITE=squeeze ARCHITECTURE=amd64 /home/jenkins/jenkins-tools/slaves/linux/build-wrapper"
    publishers:
        - email-ext:
                recipients: atagar@torproject.org
                subject: Build ${BUILD_NUMBER} of stem-tor-ci failed - log attached
                body: ${BUILD_LOG, maxLines=9999, escapeHtml=false}
    triggers:
        - pollscm: "*/10 * * * *"
    wrappers:
        - timestamps
        - timeout:
            timeout: 600
            fail: true

- job:
    name: extern-windows-libevent
    project-type: freestyle
    node: windows
    scm:
        - git:
            url: 'https://git.torproject.org/extern/libevent.git'
            branches:
                - master
    builders:
        - shell: '~/jenkins-tools/slaves/windows/build-wrapper'
    triggers:
        - pollscm: "20 * * * *"
    publishers:
        - archive:
            artifacts: "RESULT.libevent.tar.gz"
        - trigger:
            project: tor-ci-windows
    wrappers:
        - timestamps
        - timeout:
            timeout: 600
            fail: true
- job:
    name: extern-windows-openssl
    project-type: freestyle
    node: windows
    scm:
        - git:
            url: 'https://git.torproject.org/extern/openssl.git'
            branches:
                - master
    builders:
        - copyartifact:
            project: extern-windows-zlib
            which-build: "last-successful"
        - shell: '~/jenkins-tools/slaves/windows/build-wrapper'
    triggers:
        - pollscm: "25 * * * *"
    publishers:
        - archive:
            artifacts: "RESULT.openssl.tar.gz"
        - trigger:
            project: tor-ci-windows
        - trigger:
            project: extern-windows-qt
    wrappers:
        - timestamps
        - timeout:
            timeout: 600
            fail: true
- job:
    name: extern-windows-qt
    project-type: freestyle
    node: windows
    scm:
        - none:
    #    - git:
    #        url: 'https://git.torproject.org/extern/zlib.git'
    #        branches:
    #            - master
    builders:
        - copyartifact:
            project: extern-windows-openssl
            which-build: "last-successful"
        - copyartifact:
            project: extern-windows-zlib
            which-build: "last-successful"
        - shell: '~/jenkins-tools/slaves/windows/build-wrapper'
    #triggers:
    #    - pollscm: "30 * * * *"
    publishers:
        - archive:
            artifacts: "RESULT.qt.tar.gz"
        - trigger:
            project: vidalia-ci-windows
    wrappers:
        - timestamps
        - timeout:
            timeout: 600
            fail: true
- job:
    name: extern-windows-zlib
    project-type: freestyle
    node: windows
    scm:
        - git:
            url: 'https://git.torproject.org/extern/zlib.git'
            branches:
                - master
    builders:
        - shell: '~/jenkins-tools/slaves/windows/build-wrapper'
    triggers:
        - pollscm: "30 * * * *"
    publishers:
        - archive:
            artifacts: "RESULT.zlib.tar.gz"
        - trigger:
            project: extern-windows-openssl
        - trigger:
            project: extern-windows-qt
    wrappers:
        - timestamps
        - timeout:
            timeout: 600
            fail: true
